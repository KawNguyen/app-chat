// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
}

// ==================== AUTH MODELS ====================

model User {
    id            String     @id @default(cuid())
    email         String     @unique
    emailVerified Boolean    @default(false)
    name          String?
    username      String?    @unique
    displayName   String?
    image         String?
    banner        String?
    bio           String?
    status        UserStatus @default(OFFLINE)
    customStatus  String?
    createdAt     DateTime   @default(now())
    updatedAt     DateTime   @updatedAt

    // Auth relations
    accounts Account[]
    sessions Session[]

    // Server relations
    ownedServers Server[] @relation("ServerOwner")
    members      Member[]

    // Message relations
    messages  Message[]
    reactions Reaction[]

    // DM relations
    conversations  ConversationParticipant[]
    directMessages DirectMessage[]

    // Friend relations
    sentFriendRequests     FriendRequest[] @relation("SentRequests")
    receivedFriendRequests FriendRequest[] @relation("ReceivedRequests")
    friends                Friend[]        @relation("UserFriends")
    friendOf               Friend[]        @relation("FriendOf")

    // Block relations
    blockedUsers   Block[] @relation("BlockedBy")
    blockedByUsers Block[] @relation("BlockedUser")

    // Notification
    notifications Notification[]

    @@map("users")
}

enum UserStatus {
    ONLINE
    IDLE
    DND
    INVISIBLE
    OFFLINE
}

model Session {
    id        String   @id @default(cuid())
    userId    String
    expiresAt DateTime
    token     String   @unique
    ipAddress String?
    userAgent String?
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
    user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@map("sessions")
}

model Account {
    id                    String    @id @default(cuid())
    userId                String
    accountId             String
    providerId            String
    accessToken           String?
    refreshToken          String?
    idToken               String?
    accessTokenExpiresAt  DateTime?
    refreshTokenExpiresAt DateTime?
    scope                 String?
    expiresAt             DateTime?
    password              String?
    createdAt             DateTime  @default(now())
    updatedAt             DateTime  @updatedAt
    user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([providerId, accountId])
    @@map("accounts")
}

model Verification {
    id         String   @id @default(cuid())
    identifier String
    value      String
    expiresAt  DateTime
    createdAt  DateTime @default(now())
    updatedAt  DateTime @updatedAt

    @@unique([identifier, value])
    @@map("verifications")
}

// ==================== SERVER MODELS ====================

model Server {
    id          String   @id @default(cuid())
    name        String
    description String?
    icon        String?
    banner      String?
    inviteCode  String   @unique @default(cuid())
    isPublic    Boolean  @default(false)
    ownerId     String
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt

    owner      User       @relation("ServerOwner", fields: [ownerId], references: [id], onDelete: Cascade)
    members    Member[]
    channels   Channel[]
    categories Category[]
    roles      Role[]
    invites    Invite[]
    bans       Ban[]
    emojis     Emoji[]

    @@map("servers")
}

model Category {
    id        String   @id @default(cuid())
    name      String
    position  Int      @default(0)
    serverId  String
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    server   Server    @relation(fields: [serverId], references: [id], onDelete: Cascade)
    channels Channel[]

    @@map("categories")
}

model Channel {
    id          String      @id @default(cuid())
    name        String
    description String?
    type        ChannelType @default(TEXT)
    position    Int         @default(0)
    isPrivate   Boolean     @default(false)
    serverId    String
    categoryId  String?
    createdAt   DateTime    @default(now())
    updatedAt   DateTime    @updatedAt

    // Voice channel settings
    bitrate   Int?
    userLimit Int?

    server      Server              @relation(fields: [serverId], references: [id], onDelete: Cascade)
    category    Category?           @relation(fields: [categoryId], references: [id], onDelete: SetNull)
    messages    Message[]
    permissions ChannelPermission[]
    members     ChannelMember[] // Members with access to private channels

    @@map("channels")
}

enum ChannelType {
    TEXT
    VOICE
    ANNOUNCEMENT
    STAGE
    FORUM
}

// ==================== MEMBER & ROLE MODELS ====================

model Member {
    id         String   @id @default(cuid())
    userId     String
    serverId   String
    nickname   String?
    joinedAt   DateTime @default(now())
    isMuted    Boolean  @default(false)
    isDeafened Boolean  @default(false)

    user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)
    server        Server          @relation(fields: [serverId], references: [id], onDelete: Cascade)
    roles         MemberRole[]
    messages      Message[]
    channelAccess ChannelMember[] // Access to private channels

    @@unique([userId, serverId])
    @@map("members")
}

model Role {
    id        String   @id @default(cuid())
    name      String
    color     String?
    position  Int      @default(0)
    serverId  String
    isDefault Boolean  @default(false)
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Permissions (bitfield hoặc riêng lẻ)
    permissions BigInt @default(0)

    server             Server              @relation(fields: [serverId], references: [id], onDelete: Cascade)
    members            MemberRole[]
    channelPermissions ChannelPermission[]

    @@map("roles")
}

model MemberRole {
    id       String @id @default(cuid())
    memberId String
    roleId   String

    member Member @relation(fields: [memberId], references: [id], onDelete: Cascade)
    role   Role   @relation(fields: [roleId], references: [id], onDelete: Cascade)

    @@unique([memberId, roleId])
    @@map("member_roles")
}

model ChannelPermission {
    id        String @id @default(cuid())
    channelId String
    roleId    String
    allow     BigInt @default(0)
    deny      BigInt @default(0)

    channel Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)
    role    Role    @relation(fields: [roleId], references: [id], onDelete: Cascade)

    @@unique([channelId, roleId])
    @@map("channel_permissions")
}

// Member-specific access to private channels (override role permissions)
model ChannelMember {
    id          String   @id @default(cuid())
    channelId   String
    memberId    String
    permissions BigInt   @default(0) // Override permissions cho member này
    createdAt   DateTime @default(now())

    channel Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)
    member  Member  @relation(fields: [memberId], references: [id], onDelete: Cascade)

    @@unique([channelId, memberId])
    @@map("channel_members")
}

// ==================== MESSAGE MODELS ====================

model Message {
    id        String      @id @default(cuid())
    content   String
    type      MessageType @default(DEFAULT)
    isPinned  Boolean     @default(false)
    isEdited  Boolean     @default(false)
    channelId String
    memberId  String
    userId    String
    replyToId String?
    createdAt DateTime    @default(now())
    updatedAt DateTime    @updatedAt

    channel     Channel      @relation(fields: [channelId], references: [id], onDelete: Cascade)
    member      Member       @relation(fields: [memberId], references: [id], onDelete: Cascade)
    user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
    replyTo     Message?     @relation("MessageReplies", fields: [replyToId], references: [id], onDelete: SetNull)
    replies     Message[]    @relation("MessageReplies")
    attachments Attachment[]
    reactions   Reaction[]
    mentions    Mention[]
    embeds      Embed[]

    @@index([channelId, createdAt])
    @@map("messages")
}

enum MessageType {
    DEFAULT
    SYSTEM
    MEMBER_JOIN
    MEMBER_LEAVE
    CHANNEL_PINNED
    REPLY
}

model Attachment {
    id        String   @id @default(cuid())
    name      String
    url       String
    size      Int
    type      String
    messageId String
    createdAt DateTime @default(now())

    message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)

    @@map("attachments")
}

model Embed {
    id          String  @id @default(cuid())
    title       String?
    description String?
    url         String?
    color       String?
    image       String?
    thumbnail   String?
    messageId   String

    message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)

    @@map("embeds")
}

model Reaction {
    id        String   @id @default(cuid())
    emoji     String
    messageId String
    userId    String
    createdAt DateTime @default(now())

    message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
    user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([messageId, userId, emoji])
    @@map("reactions")
}

model Mention {
    id        String      @id @default(cuid())
    type      MentionType
    targetId  String
    messageId String

    message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)

    @@map("mentions")
}

enum MentionType {
    USER
    ROLE
    CHANNEL
    EVERYONE
    HERE
}

// ==================== DIRECT MESSAGE MODELS ====================

model Conversation {
    id        String   @id @default(cuid())
    isGroup   Boolean  @default(false)
    name      String?
    icon      String?
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    participants ConversationParticipant[]
    messages     DirectMessage[]

    @@map("conversations")
}

model ConversationParticipant {
    id             String    @id @default(cuid())
    userId         String
    conversationId String
    joinedAt       DateTime  @default(now())
    lastReadAt     DateTime?

    user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
    conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

    @@unique([userId, conversationId])
    @@map("conversation_participants")
}

model DirectMessage {
    id             String   @id @default(cuid())
    content        String
    conversationId String
    senderId       String
    isEdited       Boolean  @default(false)
    createdAt      DateTime @default(now())
    updatedAt      DateTime @updatedAt

    conversation Conversation              @relation(fields: [conversationId], references: [id], onDelete: Cascade)
    sender       User                      @relation(fields: [senderId], references: [id], onDelete: Cascade)
    attachments  DirectMessageAttachment[]

    @@index([conversationId, createdAt])
    @@map("direct_messages")
}

model DirectMessageAttachment {
    id              String   @id @default(cuid())
    name            String
    url             String
    size            Int
    type            String
    directMessageId String
    createdAt       DateTime @default(now())

    directMessage DirectMessage @relation(fields: [directMessageId], references: [id], onDelete: Cascade)

    @@map("direct_message_attachments")
}

// ==================== FRIEND & BLOCK MODELS ====================

model FriendRequest {
    id         String              @id @default(cuid())
    senderId   String
    receiverId String
    status     FriendRequestStatus @default(PENDING)
    createdAt  DateTime            @default(now())
    updatedAt  DateTime            @updatedAt

    sender   User @relation("SentRequests", fields: [senderId], references: [id], onDelete: Cascade)
    receiver User @relation("ReceivedRequests", fields: [receiverId], references: [id], onDelete: Cascade)

    @@unique([senderId, receiverId])
    @@map("friend_requests")
}

enum FriendRequestStatus {
    PENDING
    ACCEPTED
    DECLINED
}

model Friend {
    id        String   @id @default(cuid())
    userId    String
    friendId  String
    createdAt DateTime @default(now())

    user   User @relation("UserFriends", fields: [userId], references: [id], onDelete: Cascade)
    friend User @relation("FriendOf", fields: [friendId], references: [id], onDelete: Cascade)

    @@unique([userId, friendId])
    @@map("friends")
}

model Block {
    id        String   @id @default(cuid())
    blockerId String
    blockedId String
    createdAt DateTime @default(now())

    blocker User @relation("BlockedBy", fields: [blockerId], references: [id], onDelete: Cascade)
    blocked User @relation("BlockedUser", fields: [blockedId], references: [id], onDelete: Cascade)

    @@unique([blockerId, blockedId])
    @@map("blocks")
}

// ==================== SERVER MANAGEMENT MODELS ====================

model Invite {
    id        String    @id @default(cuid())
    code      String    @unique @default(cuid())
    serverId  String
    maxUses   Int?
    uses      Int       @default(0)
    expiresAt DateTime?
    createdAt DateTime  @default(now())

    server Server @relation(fields: [serverId], references: [id], onDelete: Cascade)

    @@map("invites")
}

model Ban {
    id        String   @id @default(cuid())
    serverId  String
    usersId   String
    reason    String?
    createdAt DateTime @default(now())

    server Server @relation(fields: [serverId], references: [id], onDelete: Cascade)

    @@unique([serverId, usersId])
    @@map("bans")
}

model Emoji {
    id        String   @id @default(cuid())
    name      String
    url       String
    serverId  String
    createdAt DateTime @default(now())

    server Server @relation(fields: [serverId], references: [id], onDelete: Cascade)

    @@map("emojis")
}

// ==================== NOTIFICATION MODEL ====================

model Notification {
    id        String           @id @default(cuid())
    userId    String
    type      NotificationType
    title     String
    content   String?
    link      String?
    isRead    Boolean          @default(false)
    createdAt DateTime         @default(now())

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([userId, isRead])
    @@map("notifications")
}

enum NotificationType {
    MESSAGE
    MENTION
    FRIEND_REQUEST
    SERVER_INVITE
    SYSTEM
}
